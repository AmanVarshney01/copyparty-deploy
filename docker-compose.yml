services:
  copyparty:
    image: copyparty/ac:latest
    container_name: copyparty
    user: "1000:1000"
    restart: unless-stopped
    ports:
      - "3923:3923"
    volumes:
      - copyparty-data:/w
    environment:
      PYTHONUNBUFFERED: "1"
      CPP_ADMIN_PASSWORD: ${CPP_ADMIN_PASSWORD:-changeme}
    command:
      - sh
      - -c
      - |
        cat > /tmp/copyparty.conf <<EOF
        [global]
          e2dsa
          e2ts
          ansi

          # Reverse proxy settings (trust Dokploy/Traefik)
          rproxy: -1
          xff-src: lan

          # CORS: trust your HTTPS domain
          acao: https://copyparty.amanv.cloud
          acam: GET,HEAD,POST,PUT,DELETE,OPTIONS

        [accounts]
          admin: $${CPP_ADMIN_PASSWORD}

        [/]
          /w
          accs:
            r: admin
            rwmda: admin
        EOF
        exec copyparty -c /tmp/copyparty.conf
    stop_grace_period: 15s
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q 127.0.0.1:3923/?reset=/._"]
      interval: 1m
      timeout: 2s
      retries: 5
      start_period: 15s

volumes:
  copyparty-data:
